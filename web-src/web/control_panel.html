<!--
 - DO WHAT THE FUCK YOU WANT TO PUBLIC LICENSE
 -                    Version 2, December 2004
 - 
 - Copyright (C) 2004 Sam Hocevar <sam@hocevar.net>
 - 
 - Everyone is permitted to copy and distribute verbatim or modified
 - copies of this license document, and changing it is allowed as long
 - as the name is changed.
 - 
 -            DO WHAT THE FUCK YOU WANT TO PUBLIC LICENSE
 -   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
 - 
 - 0. You just DO WHAT THE FUCK YOU WANT TO.
-->

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
	   <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
	   <title>MCManager</title>
	   
	   <link rel="Stylesheet" href="http://code.jquery.com/ui/1.10.0/themes/base/jquery-ui.css" />
	   
	   <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.0.js"></script>
	   <script type="text/javascript" src="http://code.jquery.com/ui/1.10.0/jquery-ui.js"></script>
	</head>
	<body>
		<style type="text/css">
			#header
			{
				border-bottom: 0px;
				height: 100px;
				margin: 1em 1em 0px;
			}
			
			#header h1
			{
				margin: 27px 0.5em;
			}
			
			nav
			{
				border-top: 0px;
				border-bottom: 0px;
				height: 36px;
				margin: 0px 1em;
			}
			
			nav ul
			{
				list-style: none;
				height: 29px;
				margin: 0px;
				padding: 6px 0px 0px 4px;
			}
			
			nav ul li
			{
				cursor: pointer;
				display: inline;
				float: left;
				padding: 3px 6px 4px;
			}
			
			nav ul li.ui-state-active
			{
				font-weight: bold !important;
			}
			
			nav ul li a
			{
				display: block;
			}
			
			#content
			{
				border-top: 0px;
				border-bottom: 0px;
				margin: 0px 1em;
				min-height: 4em;
				padding: 1em;
			}
			
			#content>div
			{
				height: 100%;
			}
			
			#content>div:not(.selected)
			{
				display: none;
			}
			
			div.section
			{
				margin-bottom: 1em;
				min-height: 3em;
				padding: 0.5em;
			}
			
			div.section:last-child
			{
				margin-bottom: 0px;
			}
			
			div.section div.title
			{
				border-top: none;
				border-left: none;
				border-right: none;
				margin: -0.5em -0.5em 0.5em;
				padding: 2px 0.5em;
			}
			
			#server-info div.section
			{
				display: inline-block;
				margin-bottom: 0px;
				text-align: center;
			}
			
			#player-list ul
			{
				list-style: none;
				margin: 0px;
				padding: 0px;
			}
			
			#player-list ul li
			{
				padding: 4px 8px;
			}
			
			#player-list ul li:not(:last-child)
			{
				border-bottom: 1px solid #AAA;
			}
			
			#content div[name=console] div.section ul
			{
				list-style: none;
				margin: 0px;
				padding: 0px;
			}
			
			#content div[name=console] div.section ul li
			{
				border-bottom: 1px solid #AAA;
				padding: 4px 6px;
			}
			
			#content div[name=console] div.section ul li:last-child
			{
				border-bottom: none;
			}
			
			#content div[name=mods] div.section table
			{
				border-collapse: collapse;
				width: 100%;
			}
			
			#content div[name=mods] div.section table td
			{
				border-right: 1px solid #AAA;
				border-bottom: 1px solid #AAA;
				text-align: center;
			}
			
			#command-args
			{
				height: 36px;
				top: 2px;
			}
			
			#status-bar
			{
				height: 26px;
				margin: 0px 1em 1em;
				padding: 4px;
			}
			
			#settings
			{
				float: right;
				margin-top: -2px;
				padding-bottom: 2px;
				width: 1.75em;
			}
			
			#settings span.ui-icon
			{
				margin-left: -9px;
			}
			
			#settings span.ui-button-text
			{
				padding: 2px;
			}
			
			#settings-dialog ul
			{
				list-style: none;
				padding: 0px;
			}
			
			#settings-dialog ul li:not(:last-child)
			{
				margin-bottom: 0.5em;
			}
			
			#settings-dialog ul li a
			{
				width: 100%;
			}
		</style>
		
		<script type="text/javascript">
			var RPC_URL = '/rpc';
		
			$(document).ready(function () {
				$('nav ul').append(new Tab('Info', 'info'))
						   .append(new Tab('Console', 'console'))
						   .append(new Tab('Mods', 'mods'));
				
				var sections = $('#content div.section');
				for (var i = 0; i != sections.length; i++) {
					var section = $(sections[i]);
					section.addClass('ui-widget-content ui-corner-all');
					
					var header = $('<div>').html(section.attr('title'))
										   .addClass('title ui-widget-header');
					
					section.prepend(header);
				}
				
				$('#content th').addClass('ui-widget-header');
				
				$('#server-controls button').button();
				$('#stop-server').click(function () {
					// TODO: add confirmation dialog
					RpcAjaxRequest('stopServer');
				});
				
				$('#command-send').button();
				
				$('#settings').button({
					icons: {
						primary: 'ui-icon-gear'
					},
					text: false
				}).click(function () {
					$('#settings-dialog').dialog('open');
				});
				
				$('#settings-dialog').dialog({
					autoOpen: false,
					minHeight: 'auto',
					modal: true
				});
				
				$('#settings-dialog ul li a').button();
				$('#disconnect').button('disable');
				
				$('#connection-error-dialog').dialog({
					autoOpen: false,
					minHeight: 'auto',
					modal: true
				}).siblings('.ui-dialog-titlebar').children('button').remove();
				
				$(window).resize(function () {
					$('#content').height($(window).height() - $('#header').outerHeight(true)
															- $('nav').outerHeight(true)
															- $('#status-bar').outerHeight(true)
															- 35);
					
					var console = $('#console');
					console.height($('#content').height() - 150);
				}).resize();
				
				update();
				setInterval(update, 1000);
			});
			
			function Tab(name, body) {
				var tab = $('<li>');
				
				tab.addClass('ui-widget-header ui-corner-top');
				
				tab.append($('<a>').html(name)
								   .attr('body', body)
								   .click(changeTab));
				
				var body = $('#content div[name=' + body + ']');
				
				if ($('nav ul li').length == 0) {
					tab.addClass('ui-state-active');
					body.addClass('selected');
				}
				
				return tab;
			}
			
			function changeTab() {
				$('nav ul li.ui-state-active').removeClass('ui-state-active');
				$('#content div.selected').removeClass('selected');
			
				var tabAnchor = $(this);
				var tab = tabAnchor.closest('li').addClass('selected');
				tab.addClass('ui-state-active');
				
				var body = $('#content div[name=' + tabAnchor.attr('body') + ']');
				body.addClass('selected');
			}
			
			function GUID() {
				var guid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
							var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
							return v.toString(16);
						});
				
				return guid;
			}
			
			function RpcRequest(method, params) {
				var json = {
					jsonrpc: '2.0',
					method: method,
					params: params,
					id: GUID()
				};
				
				return JSON.stringify(json);
			}
			
			function RpcAjaxRequest(method, params, success, failure) {
				if (params == undefined) {
					params = {};
				}
				
				var succesWrapper = function (data) {
					if ($('#connection-error-dialog').closest('.ui-dialog').css('display') != 'none') {
						$('#connection-error-dialog').dialog('close');
					}
					
					if (success != undefined) {
						success(data);
					}
				}
				
				if (failure == undefined) {
					failure = function () {
						if ($('#connection-error-dialog').closest('.ui-dialog').css('display') == 'none') {
							$('#connection-error-dialog').dialog('open');
						}
					};
				}
			
				$.ajax({
					url: '/rpc',
					type: 'POST',
					contentType: 'application/json; charset=utf-8',
					data: RpcRequest(method, params),
					dataType: 'json',
					success: success,
					error: failure
				});
			}
			
			function update() {
				updateInfo();
			}
			
			function updateInfo() {
				RpcAjaxRequest('systemInfo', {}, function (data) {
					$('#info-uptime').html(formatTime(data.params.uptime));
					$('#info-usedmemory').html(formatMemory(data.params.usedMemory));
					$('#info-maxmemory').html(formatMemory(data.params.maxMemory));
					
					var playerList = $('#player-list ul');
					playerList.children().remove();
					var players = data.params.players;
					for (var i = 0; i != players.length; i++) {
						var player = players[i];
						playerList.append($('<li>').append(player));
					}
				});
			}
			
			function formatTime(milliseconds) {
				function pad(value, zeroes) {
					if (zeroes == undefined) {
						zeroes = 2;
					}
					
					var ret = '';
					var digits = (value == 0 ? 0 : Math.floor(Math.log(value) / Math.LN10)) + 1;
					
					for (var i = digits; i != zeroes; i++) {
						ret += '0';
					}
					
					return ret + value;
				}
			
				var days = Math.floor(milliseconds / (1000 * 60 * 60 * 24));
				milliseconds -= days * 1000 * 60 * 60 * 24;
				
				var hours = Math.floor(milliseconds / (1000 * 60 * 60));
				milliseconds -= hours * 1000 * 60 * 60;
				
				var minutes = Math.floor(milliseconds / (1000 * 60));
				milliseconds -= minutes * 1000 * 60;
				
				var seconds = Math.floor(milliseconds / 1000);
				milliseconds -= seconds * 1000;
				
				var format = days > 0 ? (days + ' days ') : '';
				format += pad(hours) + ':' + pad(minutes) + ':' + pad(seconds) + ':' + pad(milliseconds, 3);
				
				return format;
			}
			
			function formatMemory(bytes) {
				var gigabytes = bytes / (1024 * 1024 * 1024);
				if (gigabytes >= 1) {
					var format = Math.round(gigabytes * 100) / 100 + ' GB';
					return format;
				}
			}
		</script>
	
		<div id="header" class="ui-widget ui-widget-header ui-corner-top">
			<h1>MCManager</h1>
		</div>
		<nav class="ui-widget ui-widget-header">
			<ul>
			</ul>
		</nav>
		<div id="content" class="ui-widget ui-widget-content">
			<div name="info">
				<div id="server-info" class="section" title="Server Info">
				    <div class="section" title="Uptime">
					   <span id="info-uptime">Offline</span>
					</div>
					<div class="section" title="Used Memory">
					   <span id="info-usedmemory">0 bytes</span>
					</div>
					<div class="section" title="Maximum Memory">
					   <span id="info-maxmemory">0 bytes</span>
					</div>
				</div>
				<div id="server-controls" class="section" title="Controls">
					<button id="stop-server">Stop</button>
				</div>
				<div id="player-list" class="section" title="Connected Players">
					<ul>
					</ul>
				</div>
			</div>
			<div name="console">
				<div class="section" title="Console Output">
					<ul id="console">
						<li>Cadyyan says hi!</li>
						<li>Server says hi!</hi>
					</ul>
				</div>
				<div class="section" title="Command">
					<select id="command-select">
						<option value="give" selected="selected">give</option>
					</select>
					<input id="command-args" class="ui-widget ui-state-default ui-corner-all" />
					<button id="command-send">Send</button>
				</div>
			</div>
			<div name="mods">
				<div class="section" title="Mods Enabled">
					<table id="mods" class="ui-widget-content">
						<thead>
							<tr>
								<th>Mod</th>
								<th>Version</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>FooCraft</td>
								<td>1.3.3.7</td>
							</tr>
							<tr>
								<td>BarCraft</td>
								<td>6.0.0.65</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
		<div id="status-bar" class="ui-widget ui-widget-header ui-corner-bottom">
			<label>Connected to:</label>
			<span id="server-connection">Nothing</span>
			<a id="settings">Settings</a>
		</div>
		
		<!-- Here be dialogs! -->
		<div id="settings-dialog" title="Settings">
			<ul>
				<li><a id="select-profile">Select Profile</a></li>
				<li><a id="disconnect">Disconnect</a></li>
			</ul>
		</div>
		<div id="connection-error-dialog" title="Connection Error">
			<p>
				There was an error in the server connection.
			</p>
			<p>
				Trying again...
			</p>
		</div>
	</body>
</html>